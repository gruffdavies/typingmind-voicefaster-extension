<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceFaster UI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="testpage.css">
    <link rel="stylesheet" href="vf-mock3.css">
</head>

<body>
    <!-- Main Widget -->
    <div class="vf-widget" data-state="idle">
        <!-- Drag Bar -->
        <div class="vf-dragbar">
            <canvas class="vf-dragbar-viz"></canvas>
            <div class="vf-dragbar-handle"></div>
        </div>


        <!-- Controls -->
        <div class="vf-controls">
            <div class="vf-mic">
                <button class="vf-button" id="vf-mic-button" data-state="idle">
                    <canvas class="vf-visualizer vf-visualizer--human"></canvas>
                    <i class="bi bi-mic-fill vf-button-mic"></i>
                </button>
            </div>

            <button class="vf-settings-btn">
                <i class="bi bi-gear"></i>
            </button>

            <div class="vf-tts">
                <button class="vf-button" id="vf-tts-button" data-state="idle">
                    <canvas class="vf-visualizer vf-visualizer--agent"></canvas>
                    <i class="bi bi-volume-up-fill vf-button-tts"></i>
                </button>
            </div>
        </div>

        <!-- Info Bar -->
        <div class="vf-info">
            <span>VoiceFaster</span>
            <span>v2.3.1</span>
        </div>

        <!-- Bubble Tray -->
        <div class="vf-bubble-tray">
            <!-- Bubbles will be dynamically inserted here -->
        </div>
    </div>

    <!-- Settings Panel (Initially Hidden) -->
    <div class="vf-settings" hidden>
        <div class="vf-settings-header">
            <span>SETTINGS</span>
            <button class="vf-settings-close"><i class="bi bi-x"></i></button>
        </div>

        <div class="vf-settings-section">
            <h3 class="vf-settings-title">Human Speech to Text</h3>
            <div class="vf-settings-controls">
                <select class="vf-settings-item">
                    <option value="deepgram">DeepGram</option>
                    <option value="webspeech">WebSpeech</option>
                </select>
                <label class="vf-settings-item">
                    <input type="checkbox" checked> TTS Staging Area
                </label>
            </div>
        </div>

        <div class="vf-settings-section">
            <h3 class="vf-settings-title">Agent Text to Speech</h3>
            <div class="vf-settings-controls">
                <select class="vf-settings-item">
                    <option value="elevenlabs">ElevenLabs</option>
                    <option value="webspeech">WebSpeech (Free)</option>
                </select>
                <label class="vf-settings-item">
                    <input type="checkbox" checked> Show History Bubbles
                </label>
                <div class="vf-settings-item">
                    <label>Bubble Lines: <input type="number" value="2" min="1" max="5"></label>
                </div>
                <div class="vf-settings-item">
                    <label>Keep Last N: <input type="number" value="9" min="1" max="20"></label>
                </div>
            </div>
        </div>
    </div>

    <!-- Transcript Panel (Initially Hidden) -->
    <div class="vf-transcript" hidden>
        <div class="vf-transcript-header">
            <span>Transcript</span>
            <button class="vf-transcript-close"><i class="bi bi-x"></i></button>
        </div>
        <div class="vf-transcript-content">
            <span class="vf-text--interim"></span>
            <span class="vf-text--final"></span>
        </div>
        <div class="vf-transcript-actions">
            <button class="vf-button--send">Send</button>
            <button class="vf-button--clear">Clear</button>
        </div>
    </div>

    <script src="mock.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Initialize visualizers inside the buttons
                const micVisualizer = new MockVisualizer({
                    className: 'human-speech',
                    color: '--vf-human',
                    xOffset: 0,
                    barCount: 8,  // Reduced for better performance
                    fftSize: 2048  // Increased for better resolution
                }).mount(document.querySelector('#vf-mic-button'));  // Mount directly to button

                const ttsVisualizer = new MockVisualizer({
                    className: 'agent-speech',
                    color: '--vf-agent',
                    xOffset: 0,
                    barCount: 8,
                    fftSize: 2048
                }).mount(document.querySelector('#vf-tts-button'));  // Mount directly to button

                // Pass visualizers to constructors
                window.mockSTT = new MockSTT(micVisualizer);
                window.mockTTS = new MockTTS(ttsVisualizer);

                // Add click handler for mic button
                const micButton = document.getElementById('vf-mic-button');
                micButton.addEventListener('click', () => {
                    const currentState = micButton.dataset.state;
                    if (currentState === 'idle') {
                        mockSTT.startRecording();
                    } else {
                        mockSTT.stopRecording();
                    }
                });

                // Make widget draggable
                makeDraggable(document.querySelector('.vf-widget'), '.vf-dragbar');

                // Add settings toggle
                const settingsBtn = document.querySelector('.vf-settings-btn');
                const settingsPanel = document.querySelector('.vf-settings');
                settingsBtn.addEventListener('click', () => {
                    settingsPanel.hidden = !settingsPanel.hidden;
                });

                addTestControls();
            } catch (err) {
                console.error('Error initializing VoiceFaster:', err);
            }
        });

        function makeDraggable(element, handle) {
            const dragHandle = element.querySelector(handle);
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            dragHandle.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            function dragStart(e) {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
                if (e.target === dragHandle) {
                    isDragging = true;
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    xOffset = currentX;
                    yOffset = currentY;
                    element.style.transform =
                        `translate(${currentX}px, ${currentY}px)`;
                }
            }

            function dragEnd() {
                isDragging = false;
            }
        }
    </script>
</body>

</html>